name: Issue Copilot Routing

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  route:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check PAT secret presence
        run: |
          if [ -z "${{ secrets.CROSS_REPO_TOKEN }}" ]; then
            echo "CROSS_REPO_TOKEN is NOT set"
            exit 1
          fi
          echo "CROSS_REPO_TOKEN is set"

      - name: Route issue to Copilot or guidance
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.CROSS_REPO_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');

            const issue = context.payload.issue;
            const issueNumber = issue.number;
            const comment = context.payload.comment;

            const triggerAuthor = 'ehuan2';
            const triggerPrefix = 'Copilot review started. General guidance (from guidelines.md):';
            const labelName = 'copilot-reviewed';

            if (!comment || comment.user?.login !== triggerAuthor) {
              core.info('Skipping: comment author does not match trigger author.');
              return;
            }

            const firstLine = (comment.body || '').split(/\r?\n/)[0].trim();
            if (firstLine !== triggerPrefix) {
              core.info('Skipping: comment does not match trigger prefix.');
              return;
            }

            const existing = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });

            const existingLabels = (existing.data.labels || [])
              .map((label) => (typeof label === 'string' ? label : label.name))
              .filter(Boolean);

            if (existingLabels.includes(labelName)) {
              core.info(`Skipping: ${labelName} label already present.`);
              return;
            }

            const guidelinesPath = path.join(process.cwd(), '.github', 'guidelines.md');
            const guidelines = fs.existsSync(guidelinesPath)
              ? fs.readFileSync(guidelinesPath, 'utf8').trim()
              : '';

            const reviewBody = guidelines
              ? `Copilot review for ${context.repo.owner}/${context.repo.repo}:\n\n${guidelines}`
              : 'Copilot review requested, but guidelines.md was not found in this repository.';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: reviewBody
            });

            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: [labelName]
              });
            } catch (error) {
              try {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: labelName,
                  color: '0e8a16',
                  description: 'Copilot review completed'
                });
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  labels: [labelName]
                });
              } catch (innerError) {
                core.warning(`Unable to add label ${labelName}: ${innerError.message}`);
              }
            }
